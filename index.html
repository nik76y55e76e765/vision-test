<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Quest AR Panel</title>
<style>
body { margin:0; overflow:hidden; }
</style>
</head>
<body>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

let camera, scene, renderer;
let controller;
let simulationObject = null;

init();

async function init() {

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const session = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["local-floor"]
  });

  renderer.xr.setReferenceSpaceType("local-floor");
  await renderer.xr.setSession(session);

  createMenu();

  controller = renderer.xr.getController(0);
  controller.addEventListener("select", onSelect);
  scene.add(controller);

  renderer.setAnimationLoop(render);
}

function createMenu() {

  const panel = new THREE.Group();
  panel.position.set(0, 1.4, -1);

  const btn1 = createButton(0x00aa00, -0.25);
  btn1.userData.action = "start";

  const btn2 = createButton(0xaa0000, 0);
  btn2.userData.action = "error";

  const btn3 = createButton(0x555555, 0.25);
  btn3.userData.action = "cancel";

  panel.add(btn1, btn2, btn3);
  scene.add(panel);
}

function createButton(color, x) {

  const geometry = new THREE.BoxGeometry(0.2, 0.1, 0.02);
  const material = new THREE.MeshBasicMaterial({ color });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.position.x = x;

  return mesh;
}

function onSelect(event) {

  const tempMatrix = new THREE.Matrix4();
  tempMatrix.identity().extractRotation(controller.matrixWorld);

  const raycaster = new THREE.Raycaster();
  raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
  raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix);

  const intersects = raycaster.intersectObjects(scene.children, true);

  if (intersects.length > 0) {

    const action = intersects[0].object.userData.action;

    if (action === "start") startSimulation();
    if (action === "cancel") cancelSimulation();
    if (action === "error") console.log("Ошибка симуляции");
  }
}

function startSimulation() {

  if (simulationObject) return;

  const geometry = new THREE.SphereGeometry(0.15, 32, 32);
  const material = new THREE.MeshBasicMaterial({
    color: 0x88ccff,
    transparent:true,
    opacity:0.5
  });

  simulationObject = new THREE.Mesh(geometry, material);
  simulationObject.position.set(0, 1.4, -1);
  scene.add(simulationObject);
}

function cancelSimulation() {

  if (!simulationObject) return;

  scene.remove(simulationObject);
  simulationObject = null;
}

function render() {
  renderer.render(scene, camera);
}
</script>

</body>
</html>
