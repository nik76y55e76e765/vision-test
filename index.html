<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XR Start Panel</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  font-family: sans-serif;
}

#ui {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  flex-direction: column;
  gap: 10px;
  z-index: 10;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
}
</style>
</head>

<body>

<button id="enterAR">Войти в AR</button>

<div id="ui">
  <button id="startSim">Начать симуляцию</button>
  <button id="errorSim">Ошибка симуляции</button>
  <button id="cancelSim">Отмена</button>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

let camera, scene, renderer;
let simulationObject;

init();

function init() {

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;

  document.body.appendChild(renderer.domElement);

  document.getElementById("enterAR").addEventListener("click", startAR);

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

async function startAR() {

  if (!navigator.xr) {
    alert("WebXR не поддерживается");
    return;
  }

  const session = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["local-floor"],
    optionalFeatures: ["dom-overlay"],
    domOverlay: { root: document.body }
  });

  renderer.xr.setReferenceSpaceType("local-floor");
  await renderer.xr.setSession(session);

  document.getElementById("enterAR").style.display = "none";
  document.getElementById("ui").style.display = "flex";

  renderer.setAnimationLoop(render);
}

function render() {
  renderer.render(scene, camera);
}

//
// ====== UI ЛОГИКА ======
//

document.getElementById("startSim").addEventListener("click", () => {

  if (simulationObject) return;

  const geometry = new THREE.SphereGeometry(0.15, 32, 32);
  const material = new THREE.MeshBasicMaterial({
    color: 0x88ccff,
    transparent: true,
    opacity: 0.5
  });

  simulationObject = new THREE.Mesh(geometry, material);
  simulationObject.position.set(0, 1.4, -1);
  scene.add(simulationObject);

});

document.getElementById("errorSim").addEventListener("click", () => {
  alert("Симуляция дала сбой");
});

document.getElementById("cancelSim").addEventListener("click", () => {

  if (simulationObject) {
    scene.remove(simulationObject);
    simulationObject = null;
  }

});
</script>

</body>
</html>
